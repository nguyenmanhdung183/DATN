#include <SPI.h>
#include <MFRC522.h>
#include <ESP32Servo.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

class RFID_Door {
      /*
  VCC    3.3V
  GND    GND
  SCK    18 YELLOW
  MOSI   23 WHITE
  MISO   19 GREEN
  SDA/SS 5 ORANGE
  RST    15 BLUE
  */
private:
    int SERVO;
    bool state = false; // M·∫∑c ƒë·ªãnh l√† ƒë√≥ng c·ª≠a
    MFRC522 rfid; // ƒê·ªëi t∆∞·ª£ng RFID
    String pw ="1234"; // M·∫≠t kh·∫©u m·∫∑c ƒë·ªãnh
    Servo myServo;
    const byte validUID[2][4] = {
        {0xC3, 0x74, 0xCD, 0x28}, // Th·∫ª 1
        {0x33, 0xA2, 0x3F, 0x14}  // Th·∫ª 2
    };
    int validUIDCount = 2; // S·ªë l∆∞·ª£ng th·∫ª h·ª£p l·ªá

public:
    RFID_Door(int SS,int RS, int SERVO) : rfid(SS, RS) { // Kh·ªüi t·∫°o RFID v·ªõi ch√¢n SS
        this->SERVO = SERVO;
    }

    void init() {
        SPI.begin(); // Kh·ªüi t·∫°o SPI (ESP32 t·ª± ƒë·ªông x·ª≠ l√Ω c√°c ch√¢n)
        rfid.PCD_Init(); // Kh·ªüi t·∫°o RFID
        myServo.attach(SERVO); // G√°n ch√¢n ƒëi·ªÅu khi·ªÉn servo
        myServo.write(0); // ƒê·∫∑t servo v·ªÅ v·ªã tr√≠ ƒë√≥ng c·ª≠a
    }
    
    bool getState() {
        return state;
    }

    void setState(bool newState) {
        state = newState;
    }

    void turnServo(int angle) {
        myServo.write(angle);
    }

    void openDoor() {
        Serial.println("‚úÖ M·ªü c·ª≠a...");
        turnServo(0); // M·ªü c·ª≠a
        state = true;
    }

    void closeDoor() {
        Serial.println("üîí ƒê√≥ng c·ª≠a...");
        turnServo(112); // ƒê√≥ng c·ª≠a
        state = false;
    }

    bool isValidUID() {
        // Ki·ªÉm tra n·∫øu UID h·ª£p l·ªá
        for (int i = 0; i < validUIDCount; i++) {
            if (memcmp(rfid.uid.uidByte, validUID[i], 4) == 0) {
                return true;
            }
        }
        return false;
    }

    void printUID() {
        Serial.print("UID: ");
        for (byte i = 0; i < rfid.uid.size; i++) {
            Serial.print(rfid.uid.uidByte[i], HEX);
            Serial.print(" ");
        }
        Serial.println();
    }

    bool checkCard() {
        bool rt = false;  // Declare rt variable
        //Serial.println("‚è≥ ƒêang ch·ªù th·∫ª...");
        if (!rfid.PICC_IsNewCardPresent()) return rt;  // Ki·ªÉm tra th·∫ª m·ªõi
        if (!rfid.PICC_ReadCardSerial()) return rt;   // ƒê·ªçc serial c·ªßa th·∫ª

        //printUID(); // In UID ra Serial Monitor
        Serial.print("checking...");
        if (isValidUID()) {
            Serial.println("‚úÖ Th·∫ª h·ª£p l·ªá");
            rt = true;
        } else {
            Serial.println("‚õî Th·∫ª kh√¥ng h·ª£p l·ªá!");
        }

        rfid.PICC_HaltA();  // D·ª´ng giao ti·∫øp v·ªõi th·∫ª
        rfid.PCD_StopCrypto1(); // D·ª´ng m√£ h√≥a d·ªØ li·ªáu
        return rt;
    }
    bool checkPassword(String input) {
        if (input == pw) {
            Serial.println("‚úÖ M·∫≠t kh·∫©u h·ª£p l·ªá");
            return true;
        } else {
            Serial.println("‚õî M·∫≠t kh·∫©u kh√¥ng h·ª£p l·ªá!");
            return false;
        }
    }

};
class OLED {
    private:
        // Th√¥ng s·ªë m√†n h√¨nh OLED
        static constexpr int SCREEN_WIDTH = 128;
        static constexpr int SCREEN_HEIGHT = 64;
        static constexpr int OLED_RESET = -1;
        static constexpr int SCREEN_ADDRESS = 0x3C;
    
        // Ch√¢n I2C c·ªßa ESP32
        static constexpr int SDA = 21;
        static constexpr int SCL = 22;
        unsigned long previousMillis = 0; 
        unsigned long currentMillis = 0;
        const long interval = 2000;
        Adafruit_SSD1306 display;
    
    public:
        OLED() : display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET) {}
    
        void init() {
            Wire.begin(SDA, SCL); // Kh·ªüi t·∫°o I2C
    
            if (!display.begin(SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS)) {
                Serial.println(F("OLED kh√¥ng t√¨m th·∫•y! Ki·ªÉm tra k·∫øt n·ªëi."));
                while (true); // D·ª´ng ch∆∞∆°ng tr√¨nh
            }
    
            display.clearDisplay();
            display.setTextSize(2);
            display.setTextColor(SSD1306_WHITE);
            display.setCursor(10, 25);
            display.print("Hello!");
            display.display();
            showHome();
        }
        void goToHomeScreen(){
            currentMillis = millis();
            if(currentMillis - previousMillis >= interval){
                previousMillis = currentMillis;
                showHome();
            }
        }
        void updatePrevious(){
            previousMillis = millis();
        }
    
        void clearDisplay() {
            display.clearDisplay();
            display.display();
        }
    
        void showText(const String& text, int x, int y) {
            display.clearDisplay(); // X√≥a m√†n h√¨nh tr∆∞·ªõc khi in ch·ªØ m·ªõi
            display.setCursor(x, y);
            display.print(text);
            display.display();
        }
    
        void showPassword(String pw){
            display.clearDisplay();
            display.setCursor(20, 15);
            display.print("Password");
            int textWidth = pw.length() * (6 * 2);
            int xStart = (128-textWidth)/2;
            display.setCursor(xStart, 40);
            display.print(pw);
            display.display();
        }
        void showWrongPassword(){
            display.clearDisplay();
            display.setCursor(35, 15);
            display.print("Wrong");
            display.setCursor(20, 35);
            display.print("Password");
            display.display();
        }
        void showCardAccepted(){
            display.clearDisplay();
            display.setCursor(40, 15);
            display.print("Card");
            display.setCursor(20, 35);
            display.print("Accepted");
            display.display();
    
        }
        void showCardRejected(){
            display.clearDisplay();
            display.setCursor(40, 15);
            display.print("Card");
            display.setCursor(20, 35);
            display.print("Rejected");
            display.display();
    
        }
        void showOK(){
            display.clearDisplay();
            display.setCursor(30, 15);
            display.print("OK!!!!");
            display.display();
    
        }
        void showHome(){
            display.clearDisplay();
            display.setCursor(10, 15);
            display.print("SmartHome");
            display.setCursor(18, 40);
            display.print("20213838");
            display.display();
        }
        void showCloseDoor(){
            display.clearDisplay();
            display.setCursor(5, 15);
            display.print("Close Door");
            display.display();
        }

    };


class keyBoard {
        private:
          const int rows = 3;
          String str ="";
          const int cols = 4;
          const int rowPins[3] = {34, 35, 32};  // Ch√¢n h√†ng (INPUT, PULLDOWN ngo√†i)
          const int colPins[4] = {27, 26, 25, 33};  // Ch√¢n c·ªôt (OUTPUT)
          
          unsigned long lastDebounceTime[3][4] = {0};  // L∆∞u th·ªùi gian debounce
          bool lastButtonState[3][4] = {false};  // Tr·∫°ng th√°i tr∆∞·ªõc ƒë√≥ c·ªßa ph√≠m
          bool buttonState[3][4] = {false};  // Tr·∫°ng th√°i hi·ªán t·∫°i
          bool keyPressed[3][4] = {false};  // L∆∞u tr·∫°ng th√°i ph√≠m ƒë√£ nh·∫•n ƒë·ªÉ tr√°nh l·∫∑p l·∫°i nh·∫•n li√™n t·ª•c
          unsigned long debounceDelay = 150;  // Th·ªùi gian debounce (20ms)
      
          String arr2[3][4] = {
              {"1", "4", "7", "L"},
              {"2", "5", "8", "0"},
              {"3", "6", "9", "R"}
          };
      
        public:
          keyBoard() {}
      
          void init() {
              // C√†i ƒë·∫∑t c√°c ch√¢n h√†ng v√† c·ªôt
              for (int i = 0; i < rows; i++) {
                  pinMode(rowPins[i], INPUT);  // D√πng ƒëi·ªán tr·ªü Pull-Down ngo√†i
              }
              for (int j = 0; j < cols; j++) {
                  pinMode(colPins[j], OUTPUT);
                  digitalWrite(colPins[j], LOW);  // ƒê·∫∑t ban ƒë·∫ßu l√† LOW
              }
          }
      
          void reset() {
              // ƒê·∫∑t l·∫°i tr·∫°ng th√°i ph√≠m ƒë√£ nh·∫•n
              for (int i = 0; i < rows; i++) {
                  for (int j = 0; j < cols; j++) {
                      keyPressed[i][j] = false;
                      buttonState[i][j] = false;  // ƒê·∫∑t l·∫°i tr·∫°ng th√°i ph√≠m
                      lastButtonState[i][j] = false;  // ƒê·∫∑t l·∫°i tr·∫°ng th√°i tr∆∞·ªõc ƒë√≥
                      lastDebounceTime[i][j] = 0;  // ƒê·∫∑t l·∫°i th·ªùi gian debounce
                  }
              }
          }
          String getPressKey() {
              String rt = "null";
              unsigned long currentTime = millis();
      
              // Qu√©t qua c√°c c·ªôt
              for (int i = 0; i < cols; i++) {
                  digitalWrite(colPins[i], HIGH);  // K√≠ch ho·∫°t c·ªôt
      
                  // Qu√©t qua c√°c h√†ng
                  for (int j = 0; j < rows; j++) {
                      bool reading = digitalRead(rowPins[j]);  // ƒê·ªçc tr·∫°ng th√°i ph√≠m
      
                      // Ki·ªÉm tra debounce
                      if (reading != lastButtonState[j][i]) {
                          lastDebounceTime[j][i] = currentTime;  // L∆∞u l·∫°i th·ªùi gian khi c√≥ thay ƒë·ªïi
                      }
      
                      if ((currentTime - lastDebounceTime[j][i]) > debounceDelay) {
                          if (reading == HIGH && !keyPressed[j][i]) {  // Ph√≠m ƒë∆∞·ª£c nh·∫•n l·∫ßn ƒë·∫ßu
                              rt = arr2[j][i];  // L∆∞u ph√≠m nh·∫•n
                              keyPressed[j][i] = true;  // ƒê√°nh d·∫•u l√† ƒë√£ nh·∫•n
                          } 
                          else if (reading == LOW && keyPressed[j][i]) {  // Ph√≠m ƒë∆∞·ª£c th·∫£ ra
                              keyPressed[j][i] = false;  // ƒê√°nh d·∫•u l√† ph√≠m ƒë√£ ƒë∆∞·ª£c th·∫£
                          }
                          buttonState[j][i] = reading;  // C·∫≠p nh·∫≠t tr·∫°ng th√°i hi·ªán t·∫°i
                      }
      
                      lastButtonState[j][i] = reading;  // C·∫≠p nh·∫≠t tr·∫°ng th√°i tr∆∞·ªõc ƒë√≥
                  }
      
                  digitalWrite(colPins[i], LOW);  // T·∫Øt c·ªôt
              }
      
              return rt;  // Tr·∫£ v·ªÅ ph√≠m ƒë√£ nh·∫•n ho·∫∑c "null" n·∫øu kh√¥ng c√≥ ph√≠m nh·∫•n
          }
      
      
          void updateStr(String a){
              str += a;
      
          }
      
      
          String getStr(){
              return str;  // Tr·∫£ v·ªÅ chu·ªói str
          }   
          void deleteStr(){
              str = "";  // X√≥a chu·ªói str
          }
      };
// T·∫°o ƒë·ªëi t∆∞·ª£ng RFID_Door v·ªõi ch√¢n SS l√† 5 v√† servo k·∫øt n·ªëi v·ªõi ch√¢n 12
RFID_Door door(5,15, 12);// ch√¢n t·ª© 3 l√† servo 5V (12) /18 23 19 5 22 12 15
OLED oled; // T·∫°o ƒë·ªëi t∆∞·ª£ng OLED SDA=21 SCL=22
keyBoard kb; // pin: 34 35 32 27 26 25 33
bool isTypePW = false;


void allDoor(){
    if (door.checkCard()) {
        if (door.getState()) {
            door.closeDoor(); // N·∫øu c·ª≠a ƒëang m·ªü th√¨ ƒë√≥ng l·∫°i
            oled.showCloseDoor();
            oled.updatePrevious(); // C·∫≠p nh·∫≠t th·ªùi gian tr∆∞·ªõc ƒë√≥
            isTypePW = false; // ƒê·∫∑t l·∫°i tr·∫°ng th√°i nh·∫≠p m·∫≠t kh·∫©u
        } else {
            door.openDoor(); // N·∫øu c·ª≠a ƒëang ƒë√≥ng th√¨ m·ªü ra
            oled.showCardAccepted(); // Hi·ªÉn th·ªã th√¥ng b√°o m·ªü c·ª≠a
            oled.updatePrevious(); // C·∫≠p nh·∫≠t th·ªùi gian tr∆∞·ªõc ƒë√≥
            isTypePW = false; // ƒê·∫∑t l·∫°i tr·∫°ng th√°i nh·∫≠p m·∫≠t kh·∫©u
        }
    }

    String key = kb.getPressKey(); // L·∫•y ph√≠m nh·∫•n t·ª´ b√†n ph√≠m
    if (key != "null") {
        isTypePW = true;
        Serial.println(key); // In ph√≠m nh·∫•n ra Serial Monitor
        if (key == "L") {
            kb.deleteStr(); // X√≥a chu·ªói khi nh·∫•n L
            oled.showPassword(kb.getStr());
        } else if (key == "R") {
            oled.showPassword(kb.getStr());
            if(door.getState() && kb.getStr() == "") {
                door.closeDoor();
                oled.showCloseDoor(); // N·∫øu c·ª≠a ƒëang m·ªü th√¨ ƒë√≥ng l·∫°i
                oled.updatePrevious(); // C·∫≠p nh·∫≠t th·ªùi gian tr∆∞·ªõc ƒë√≥
                isTypePW = false;
                
            }else{
                if(door.checkPassword(kb.getStr())) {
                    door.openDoor(); // N·∫øu m·∫≠t kh·∫©u ƒë√∫ng th√¨ m·ªü c·ª≠a
                    oled.showOK();
                    oled.updatePrevious(); // C·∫≠p nh·∫≠t th·ªùi gian tr∆∞·ªõc ƒë√≥
                    isTypePW = false;
                } else {
                    oled.showWrongPassword();
                    oled.updatePrevious(); // C·∫≠p nh·∫≠t th·ªùi gian tr∆∞·ªõc ƒë√≥
                    isTypePW = false;
                }
            }
            kb.deleteStr(); // X√≥a chu·ªói sau khi ki·ªÉm tra m·∫≠t kh·∫©u
        } else {
            kb.updateStr(key);
            oled.showPassword(kb.getStr());
            isTypePW = true; // ƒê√°nh d·∫•u l√† ƒëang nh·∫≠p m·∫≠t kh·∫©u
        }
        kb.reset(); // ƒê·∫∑t l·∫°i tr·∫°ng th√°i b√†n ph√≠m sau khi nh·∫•n
    }

   //delay(500); // Ch·ªù 500ms ƒë·ªÉ tr√°nh tr√πng l·∫∑p qu√° nhanh
   if(!isTypePW){
    oled.goToHomeScreen();
   }
}
void setup() {

    Serial.begin(115200);
    door.init();
    oled.init();
    kb.init();

}

void loop() {
   allDoor(); 
}
 