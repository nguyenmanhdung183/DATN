#include <SPI.h>
#include <MFRC522.h>
#include <ESP32Servo.h>

class RFID_Door {
      /*
  VCC    3.3V
  GND    GND
  SCK    18 YELLOW
  MOSI   23 WHITE
  MISO   19 GREEN
  SDA/SS 5 ORANGE
  RST    22
  */
private:
    int SERVO;
    bool state = false; // Máº·c Ä‘á»‹nh lÃ  Ä‘Ã³ng cá»­a
    MFRC522 rfid; // Äá»‘i tÆ°á»£ng RFID
    Servo myServo;
    const byte validUID[2][4] = {
        {0xC3, 0x74, 0xCD, 0x28}, // Tháº» 1
        {0x33, 0xA2, 0x3F, 0x14}  // Tháº» 2
    };
    int validUIDCount = 2; // Sá»‘ lÆ°á»£ng tháº» há»£p lá»‡

public:
    RFID_Door(int SS,int RS, int SERVO) : rfid(SS, RS) { // Khá»Ÿi táº¡o RFID vá»›i chÃ¢n SS
        this->SERVO = SERVO;
    }

    void init() {
        SPI.begin(); // Khá»Ÿi táº¡o SPI (ESP32 tá»± Ä‘á»™ng xá»­ lÃ½ cÃ¡c chÃ¢n)
        rfid.PCD_Init(); // Khá»Ÿi táº¡o RFID
        myServo.attach(SERVO); // GÃ¡n chÃ¢n Ä‘iá»u khiá»ƒn servo
        myServo.write(0); // Äáº·t servo vá» vá»‹ trÃ­ Ä‘Ã³ng cá»­a
    }
    
    bool getState() {
        return state;
    }

    void setState(bool newState) {
        state = newState;
    }

    void turnServo(int angle) {
        myServo.write(angle);
    }

    void openDoor() {
        Serial.println("âœ… Má»Ÿ cá»­a...");
        turnServo(90); // Má»Ÿ cá»­a
        state = true;
    }

    void closeDoor() {
        Serial.println("ğŸ”’ ÄÃ³ng cá»­a...");
        turnServo(0); // ÄÃ³ng cá»­a
        state = false;
    }

    bool isValidUID() {
        // Kiá»ƒm tra náº¿u UID há»£p lá»‡
        for (int i = 0; i < validUIDCount; i++) {
            if (memcmp(rfid.uid.uidByte, validUID[i], 4) == 0) {
                return true;
            }
        }
        return false;
    }

    void printUID() {
        Serial.print("UID: ");
        for (byte i = 0; i < rfid.uid.size; i++) {
            Serial.print(rfid.uid.uidByte[i], HEX);
            Serial.print(" ");
        }
        Serial.println();
    }

    bool checkCard() {
        bool rt = false;  // Declare rt variable
        //Serial.println("â³ Äang chá» tháº»...");
        if (!rfid.PICC_IsNewCardPresent()) return rt;  // Kiá»ƒm tra tháº» má»›i
        if (!rfid.PICC_ReadCardSerial()) return rt;   // Äá»c serial cá»§a tháº»

        //printUID(); // In UID ra Serial Monitor
        Serial.print("checking...");
        if (isValidUID()) {
            Serial.println("âœ… Tháº» há»£p lá»‡");
            rt = true;
        } else {
            Serial.println("â›” Tháº» khÃ´ng há»£p lá»‡!");
        }

        rfid.PICC_HaltA();  // Dá»«ng giao tiáº¿p vá»›i tháº»
        rfid.PCD_StopCrypto1(); // Dá»«ng mÃ£ hÃ³a dá»¯ liá»‡u
        return rt;
    }
};

// Táº¡o Ä‘á»‘i tÆ°á»£ng RFID_Door vá»›i chÃ¢n SS lÃ  5 vÃ  servo káº¿t ná»‘i vá»›i chÃ¢n 12
RFID_Door door(5,15, 12);//18 23 19 5 22 12 15

void setup() {

    Serial.begin(115200);
    door.init();

}

void loop() {
    if (door.checkCard()) {
        if (door.getState()) {
            door.closeDoor(); // Náº¿u cá»­a Ä‘ang má»Ÿ thÃ¬ Ä‘Ã³ng láº¡i
        } else {
            door.openDoor(); // Náº¿u cá»­a Ä‘ang Ä‘Ã³ng thÃ¬ má»Ÿ ra
        }
    }
   //delay(500); // Chá» 500ms Ä‘á»ƒ trÃ¡nh trÃ¹ng láº·p quÃ¡ nhanh
}
